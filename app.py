import streamlit as st
import pandas as pd
import requests
import time

# --- НАСТРОЙКИ СТРАНИЦЫ ---
st.set_page_config(layout="wide", page_title="GrowthLoop Hybrid Pro v3.4")

# --- КЛЮЧИ API ---
FNS_API_KEY = "8f1364cd9916da3ba62170204442a80566bc5f29"
OFDATA_API_KEY = "4ag8CvRHFhXpwzOz"

# --- СПРАВОЧНИК РЕГИОНОВ ---
REGIONS = {
    "Все регионы": "", "01 - Адыгея": "01", "02 - Башкортостан": "02", "03 - Бурятия": "03", "04 - Алтай": "04",
    "05 - Дагестан": "05", "06 - Ингушетия": "06", "07 - Кабардино-Балкария": "07", "08 - Калмыкия": "08",
    "09 - Карачаево-Черкесия": "09", "10 - Карелия": "10", "11 - Коми": "11", "12 - Марий Эл": "12",
    "13 - Мордовия": "13", "14 - Якутия": "14", "15 - Северная Осетия": "15", "16 - Татарстан": "16",
    "17 - Тыва": "17", "18 - Удмуртия": "18", "19 - Хакасия": "19", "20 - Чечня": "20", "21 - Чувашия": "21",
    "22 - Алтайский край": "22", "23 - Краснодарский край": "23", "24 - Красноярский край": "24",
    "25 - Приморский край": "25", "26 - Ставропольский край": "26", "27 - Хабаровский край": "27",
    "28 - Амурская обл.": "28", "29 - Архангельская обл.": "29", "30 - Астраханская обл.": "30",
    "31 - Белгородская обл.": "31", "32 - Брянская обл.": "32", "33 - Владимирская обл.": "33",
    "34 - Волгоградская обл.": "34", "35 - Вологодская обл.": "35", "36 - Воронежская обл.": "36",
    "37 - Ивановская обл.": "37", "38 - Иркутская обл.": "38", "39 - Калининградская обл.": "39",
    "40 - Калужская обл.": "40", "41 - Камчатский край": "41", "42 - Кемеровская обл.": "42",
    "43 - Кировская обл.": "43", "44 - Костромская обл.": "44", "45 - Курганская обл.": "45",
    "46 - Курская обл.": "46", "47 - Ленинградская обл.": "47", "48 - Липецкая обл.": "48",
    "49 - Магаданская обл.": "49", "50 - Московская обл.": "50", "51 - Мурманская обл.": "51",
    "52 - Нижегородская обл.": "52", "53 - Новгородская обл.": "53", "54 - Новосибирская обл.": "54",
    "55 - Омская обл.": "55", "56 - Оренбургская обл.": "56", "57 - Орловская обл.": "57",
    "58 - Пензенская обл.": "58", "59 - Пермский край": "59", "60 - Псковская обл.": "60",
    "61 - Ростовская обл.": "61", "62 - Рязанская обл.": "62", "63 - Самарская обл.": "63",
    "64 - Саратовская обл.": "64", "65 - Сахалинская обл.": "65", "66 - Свердловская обл.": "66",
    "67 - Смоленская обл.": "67", "68 - Тамбовская обл.": "68", "69 - Тверская обл.": "69",
    "70 - Томская обл.": "70", "71 - Тульская обл.": "71", "72 - Тюменская обл.": "72",
    "73 - Ульяновская обл.": "73", "74 - Челябинская обл.": "74", "75 - Забайкальский край": "75",
    "76 - Ярославская обл.": "76", "77 - Москва": "77", "78 - Санкт-Петербург": "78",
    "79 - Еврейская АО": "79", "82 - Крым": "82", "83 - Ненецкий АО": "83", "86 - ХМАО": "86",
    "87 - Чукотский АО": "87", "89 - Ямало-Ненецкий АО": "89", "92 - Севастополь": "92"
}

# --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

def clean_val(val):
    if not val: return ""
    if isinstance(val, list):
        if not val: return ""
        if isinstance(val[0], dict):
            items = []
            for i in val:
                name = i.get('ФИ
